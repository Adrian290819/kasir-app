<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kasir Futuristik - KasirApp</title>
  <link rel="stylesheet" href="style-kasirapp.css" />
  <link rel="stylesheet" href="style.promo.css" />
  <link rel="stylesheet" href="style-tema.css" />
  <link rel="stylesheet" href="style-kasir.css" />
  <script src="tema.js" defer></script>
  <style>
    @media (max-width: 768px) {
      .dashboard-container {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
        padding: 10px;
      }

      .sidebar nav {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
      }

      .sidebar nav a {
        margin: 6px;
        padding: 10px 14px;
        font-size: 0.9rem;
      }

      main {
        padding: 20px;
      }

      .summary-section {
        flex-direction: column;
        align-items: center;
      }

      .card {
        width: 100%;
      }

      table {
        font-size: 0.9rem;
      }
    }
</style>
</head>
<body>
  <div class="dashboard-container">
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2>ðŸ§¾ Kasir Mutia</h2>
      </div>
      <nav>
        <a href="dashboard.html">Dashboard</a>
      <a href="kasir.html"class="active">Transaksi Kasir</a>
      <a href="riwayat.html">Riwayat Transaksi</a>
      <a href="data-produk.html">Data Produk</a>
      <a href="pengeluaran.html">Pengeluaran</a>
      <a href="statistik-penjualan.html">Statistik Penjualan</a>
      <a href="laporan.html">Laporan</a>
      <a href="stok-masuk.html">Stok Masuk</a>
      <a href="supplier.html">Supplier</a>
      <a href="retur-barang.html">Retur Barang</a>
      <a href="qr-code-produk.html">QR Code Produk</a>
      <a href="backup-restore.html">Backup & Restore</a>
      <a href="pengaturan.html">Pengaturan</a>
        <button id="logout-btn" class="btn-logout">Logout</button>  
        <div style="padding: 10px; text-align: center;">
          <button onclick="toggleSidebar()" class="hamburger-btn">â˜°</button>
        </div>
      </nav>
    </aside>

    <main>
      <header>
        <h1>Transaksi Kasir</h1>
      </header>

      <input type="text" id="search-input" placeholder="Cari produk..." />

      <div id="kategori-buttons">
  <button class="kategori-btn active" onclick="filterByCategory('Semua', this)">
    <img src="https://iili.io/Fi6KJqb.png" /> Semua
  </button>
  <button class="kategori-btn" onclick="filterByCategory('Makanan', this)">
    <img src="https://img.icons8.com/emoji/32/fork-and-knife-with-plate-emoji.png" /> Makanan
  </button>
  <button class="kategori-btn" onclick="filterByCategory('Minuman', this)">
    <img src="https://iili.io/FiI2KKX.png" /> Minuman
  </button>
  <button class="kategori-btn" onclick="filterByCategory('Alkohol', this)">
    <img src="https://img.icons8.com/emoji/32/beer-mug.png" /> Alkohol
  </button>
  <button class="kategori-btn" onclick="filterByCategory('Snack', this)">
    <img src="https://iili.io/FiIfnr7.png" /> Snack
  </button>
  <button class="kategori-btn" onclick="filterByCategory('Lainnya', this)">
    <img src="https://iili.io/FiICAIs.png" /> Lainnya
  </button>
</div>

      <div class="produk-list" id="produk-list"></div>

      <form id="form-transaksi">
        <input type="number" id="jumlah-input" placeholder="Jumlah" min="1" required />
        <button type="submit">Tambah</button>
        <button type="button" id="hapus-semua-btn" class="delete-btn">Hapus Semua</button>
        <button type="button" id="checkout-btn" class="edit-btn">Checkout</button>
      </form>

      <table>
        <thead>
          <tr>
            <th>Produk</th>
            <th>Jumlah</th>
            <th>Harga</th>
            <th>Total</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="transaksi-body"></tbody>
      </table>

      <div class="checkout-summary">
        <span>Total Belanja:</span>
        <span id="total-belanja">Rp 0</span>
      </div>
    </main>
  </div>

  <!-- Popup Checkout -->
  <div class="popup" id="popup-confirm">
    <div class="popup-content">
      <h3>Konfirmasi Checkout</h3>
      <p>Total belanja: <strong id="popup-total"></strong></p>
      <button onclick="printStruk()">Cetak Struk</button>
      <button onclick="selesaikanTanpaCetak()">Tanpa Cetak</button>
      <button onclick="tutupPopup()">Batal</button>
    </div>
  </div>

  <!-- Print Section -->
  <div id="print-section" style="display:none;">
    <h3>ðŸ§¾ Struk KasirApp</h3>
    <ul id="print-items"></ul>
    <p><strong>Total: <span id="print-total"></span></strong></p>
  </div>

  <script>
if (localStorage.getItem('isLoggedIn') !== 'true') {
  location.href = 'login.html';
}

document.getElementById('logout-btn').onclick = () => {
  if (confirm('Yakin logout?')) {
    localStorage.removeItem('isLoggedIn');
    localStorage.removeItem('username');
    location.href = 'login.html';
  }
};

const username = localStorage.getItem('username') || 'guest';
const produkKey = `kasirapp_produk_list_${username}`;
let produkList = JSON.parse(localStorage.getItem(produkKey) || '[]');

// Normalisasi data produk
produkList = produkList.map((p, index) => ({
  id: p.id || `prod-${index}-${Date.now()}`,
  name: p.name || p.nama || "",
  price: Number(p.price ?? p.harga ?? 0),
  stock: Number(p.stock ?? p.stok ?? 0),
  category: p.category || p.kategori || "Lainnya",
  image: p.image || p.gambar || ""
}));

// Simpan kembali hasil normalisasi
localStorage.setItem(produkKey, JSON.stringify(produkList));

const transaksiKey = `kasirapp_transaksi_list_${username}`;
const produkListElem = document.getElementById('produk-list');
const transaksiBody = document.getElementById('transaksi-body');
const jumlahInput = document.getElementById('jumlah-input');
const formTransaksi = document.getElementById('form-transaksi');
const totalBelanjaLabel = document.getElementById('total-belanja');
const searchInput = document.getElementById('search-input');
const hapusSemuaBtn = document.getElementById('hapus-semua-btn');
const checkoutBtn = document.getElementById('checkout-btn');
const popup = document.getElementById('popup-confirm');
const popupTotal = document.getElementById('popup-total');
const printItems = document.getElementById('print-items');
const printTotal = document.getElementById('print-total');

let transaksiList = [];
let selectedProduk = null;
let currentCategory = 'Semua';

function filterByCategory(kategori) {
  currentCategory = kategori;
  renderProdukList(searchInput.value);
}

function renderProdukList(filter = '') {
  produkListElem.innerHTML = '';
  produkList
    .filter(p =>
      p.name.toLowerCase().includes(filter.toLowerCase()) &&
      (currentCategory === 'Semua' || p.category === currentCategory)
    )
    .forEach(p => {
      const card = document.createElement('div');
      card.className = 'produk-card' + (selectedProduk?.id === p.id ? ' active' : '');
      card.innerHTML = `
        <img src="${p.image || 'https://via.placeholder.com/160x100?text=Gambar'}" alt="${p.name}" />
        <div class="produk-card-body">
          <h4>${p.name}</h4>
          <p>Rp ${p.price.toLocaleString('id-ID')}<br><small>Stok: ${p.stock}</small></p>
        </div>
      `;
      card.onclick = () => { selectedProduk = p; renderProdukList(searchInput.value); };
      produkListElem.appendChild(card);
    });
}

formTransaksi.onsubmit = e => {
  e.preventDefault();
  const jumlah = parseInt(jumlahInput.value);
  if (!selectedProduk || isNaN(jumlah) || jumlah <= 0) return;

  const idx = produkList.findIndex(p => p.id === selectedProduk.id);
  if (produkList[idx].stock < jumlah) {
    alert('Stok tidak mencukupi!');
    return;
  }

  const total = selectedProduk.price * jumlah;
  transaksiList.push({
    productName: selectedProduk.name,
    quantity: jumlah,
    pricePerUnit: selectedProduk.price,
    total
  });
  formTransaksi.reset();
  renderTransaksi();
};

function renderTransaksi() {
  transaksiBody.innerHTML = '';
  let total = 0;
  transaksiList.forEach((tx, i) => {
    total += tx.total;
    transaksiBody.innerHTML += `
      <tr>
        <td>${tx.productName}</td>
        <td>${tx.quantity}</td>
        <td>Rp ${tx.pricePerUnit.toLocaleString('id-ID')}</td>
        <td>Rp ${tx.total.toLocaleString('id-ID')}</td>
        <td><button class="delete-btn" onclick="hapusTransaksi(${i})">Hapus</button></td>
      </tr>
    `;
  });
  totalBelanjaLabel.textContent = 'Rp ' + total.toLocaleString('id-ID');
  popupTotal.textContent = totalBelanjaLabel.textContent;
}

function hapusTransaksi(i) {
  transaksiList.splice(i, 1);
  renderTransaksi();
}

hapusSemuaBtn.onclick = () => {
  if (confirm('Hapus semua transaksi?')) {
    transaksiList = [];
    renderTransaksi();
  }
};

function simpanTransaksiKeLocalStorage() {
  const existing = JSON.parse(localStorage.getItem(transaksiKey) || '[]');
  const now = new Date();
  const today = now.toISOString().slice(0, 10);
  const currentTime = now.toTimeString().split(' ')[0];

  const transaksiDenganTanggal = transaksiList.map(tx => ({
    ...tx,
    date: today,
    time: currentTime
  }));

  // Update stok
  transaksiList.forEach(tx => {
    const idx = produkList.findIndex(p => p.name === tx.productName);
    if (idx !== -1) {
      produkList[idx].stock = Math.max(0, produkList[idx].stock - tx.quantity);
    }
  });

  localStorage.setItem(produkKey, JSON.stringify(produkList));
  localStorage.setItem(transaksiKey, JSON.stringify([...existing, ...transaksiDenganTanggal]));
}

checkoutBtn.onclick = () => {
  if (!transaksiList.length) {
    alert('Keranjang kosong!');
    return;
  }
  popup.style.display = 'flex';
};

function selesaikanTanpaCetak() {
  simpanTransaksiKeLocalStorage();
  transaksiList = [];
  renderTransaksi();
  tutupPopup();
  alert("Transaksi disimpan tanpa mencetak struk.");
}

function printStruk() {
  simpanTransaksiKeLocalStorage();
  printItems.innerHTML = transaksiList
    .map(tx => `<li>${tx.productName} x${tx.quantity} = Rp ${tx.total.toLocaleString('id-ID')}</li>`)
    .join('');
  printTotal.textContent = popupTotal.textContent;
  document.getElementById('print-section').style.display = 'block';
  window.print();
  document.getElementById('print-section').style.display = 'none';
  transaksiList = [];
  renderTransaksi();
  tutupPopup();
}

function tutupPopup() {
  popup.style.display = 'none';
}

searchInput.oninput = () => renderProdukList(searchInput.value);
renderProdukList();
renderTransaksi();

function toggleSidebar() {
  document.querySelector('.sidebar').classList.toggle('open');
}
document.querySelectorAll('.sidebar nav a').forEach(link => {
  link.addEventListener('click', () => {
    if (window.innerWidth <= 768) {
      document.querySelector('.sidebar').classList.remove('open');
    }
  });
});
</script>
</body>
</html>
